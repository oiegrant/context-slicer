<!DOCTYPE html>
<html>
<head>
<title>TECHNICAL_IMPLEMENTATION.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="context-slice--technical-implementation-document">Context Slice — Technical Implementation Document</h1>
<p><strong>Version:</strong> 0.1 — MVP
<strong>Derived from:</strong> Architecture v1.0</p>
<hr>
<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="#1-repository-layout">Repository Layout</a></li>
<li><a href="#2-system-map">System Map</a></li>
<li><a href="#3-subsystem-zig-core">Subsystem: Zig Core</a></li>
<li><a href="#4-subsystem-java-adapter">Subsystem: Java Adapter</a></li>
<li><a href="#5-subsystem-bytebuddy-agent">Subsystem: ByteBuddy Agent</a></li>
<li><a href="#6-shared-artifact-space----context-slice">Shared Artifact Space — <code>.context-slice/</code></a></li>
<li><a href="#7-subsystem-boundaries">Subsystem Boundaries</a></li>
<li><a href="#8-data-flow-summary">Data Flow Summary</a></li>
</ol>
<hr>
<h2 id="1-repository-layout">1. Repository Layout</h2>
<pre class="hljs"><code><div>context-slicer/                          # Repo root
  ├── context-slicer/                    # Zig core binary
  │   ├── build.zig
  │   ├── build.zig.zon
  │   └── src/
  │       ├── main.zig
  │       ├── cli/
  │       ├── orchestrator/
  │       ├── ir/
  │       ├── graph/
  │       ├── compression/
  │       ├── packager/
  │       ├── ai/
  │       └── util/
  ├── context-adapter-java/              # Java adapter subprocess (fat JAR)
  │   ├── pom.xml
  │   └── src/main/java/com/contextslice/adapter/
  ├── context-agent-java/                # ByteBuddy Java Agent (separate JAR)
  │   ├── pom.xml
  │   └── src/main/java/com/contextslice/agent/
  └── TECHNICAL_IMPLEMENTATION.md
</div></code></pre>
<p>The Zig core and Java components are <strong>separate build artifacts</strong>. The Zig binary ships alongside the adapter JAR and agent JAR. The agent JAR must be a separate artifact because it is attached via <code>-javaagent:</code> to the <em>target application's</em> JVM, not to the adapter's JVM.</p>
<hr>
<h2 id="2-system-map">2. System Map</h2>
<pre class="hljs"><code><div>┌───────────────────────────────────────────────────────────┐
│                     ZIG CORE BINARY                       │
│                                                           │
│  ┌────────────┐    ┌──────────────────┐                   │
│  │  CLI Layer │───▶│  Orchestrator    │                   │
│  └────────────┘    └────────┬─────────┘                   │
│                             │ spawns subprocess            │
│                             ▼                             │
│  ┌──────────────────────────────────────────────────────┐ │
│  │               IR Layer                               │ │
│  │  Loader ──▶ Validator ──▶ Merger ──▶ IR Types        │ │
│  └────────────────────────┬─────────────────────────────┘ │
│                           ▼                               │
│  ┌──────────────────────────────────────────────────────┐ │
│  │               Graph Layer                            │ │
│  │  Builder ──▶ Graph ──▶ Traversal ──▶ Expansion       │ │
│  └────────────────────────┬─────────────────────────────┘ │
│                           ▼                               │
│  ┌──────────────────────────────────────────────────────┐ │
│  │            Compression Layer                         │ │
│  │  Filter ──▶ Dedup ──▶ Compressor                     │ │
│  └────────────────────────┬─────────────────────────────┘ │
│                           ▼                               │
│  ┌──────────────────────────────────────────────────────┐ │
│  │               Packager Layer                         │ │
│  │  architecture_writer · config_writer · packager      │ │
│  └────────────────────────┬─────────────────────────────┘ │
│                           ▼                               │
│  ┌──────────────────────────────────────────────────────┐ │
│  │             AI Integration Layer                     │ │
│  │  prompt_builder ──▶ claude (HTTP client)             │ │
│  └──────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────┘
          │ file IPC (manifest.json)       ▲
          │                               │ file IPC (IR JSON files)
          ▼                               │
┌───────────────────────────────────────────────────────────┐
│              JAVA ADAPTER (subprocess JAR)                │
│                                                           │
│  AdapterMain ──▶ ManifestReader                           │
│       │                                                   │
│       ├──▶ ┌──────────────────────────┐                   │
│       │    │   Static Analysis Module │                   │
│       │    │  SourceRootResolver      │                   │
│       │    │  JdtAstParser            │                   │
│       │    │  SymbolExtractor         │                   │
│       │    │  CallEdgeExtractor       │                   │
│       │    │  AnnotationProcessor     │                   │
│       │    └──────────────────────────┘                   │
│       │                                                   │
│       ├──▶ ┌──────────────────────────┐                   │
│       │    │  Runtime Instrumenta-    │                   │
│       │    │  tion Module             │                   │
│       │    │  BuildRunner             │                   │
│       │    │  AgentLauncher           │                   │
│       │    └──────────────────────────┘                   │
│       │                                                   │
│       └──▶ ┌──────────────────────────┐                   │
│            │  IR Emitter              │                   │
│            │  IrMerger                │                   │
│            │  IrSerializer            │                   │
│            └──────────────────────────┘                   │
└───────────────────────────────────────────────────────────┘
                         │ -javaagent:
                         ▼
          ┌──────────────────────────────────┐
          │    BYTEBUDDY AGENT JAR           │
          │   (attached to target app JVM)   │
          │                                  │
          │  AgentBootstrap                  │
          │  MethodAdvice                    │
          │  ConfigAdvice                    │
          │  RuntimeTracer                   │
          │  ShutdownHook ──▶ runtime_trace.json │
          └──────────────────────────────────┘
</div></code></pre>
<hr>
<h2 id="3-subsystem-zig-core">3. Subsystem: Zig Core</h2>
<h3 id="31-cli-layer">3.1 CLI Layer</h3>
<p><strong>Location:</strong> <code>context-slicer/src/cli/</code>
<strong>Role:</strong> Parse command-line arguments and dispatch to the correct command handler. No business logic lives here.</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Struct / Function</th>
<th>Responsibility</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>main.zig</code></td>
<td><code>main()</code></td>
<td>Process entry point; initializes allocator, calls <code>cli.run()</code></td>
</tr>
<tr>
<td><code>cli/cli.zig</code></td>
<td><code>Cli</code>, <code>run()</code></td>
<td>Parses <code>argv</code>, routes to subcommand handler</td>
</tr>
<tr>
<td><code>cli/commands/record.zig</code></td>
<td><code>RecordCommand</code>, <code>execute()</code></td>
<td>Handles <code>context-slice record &lt;scenario&gt;</code></td>
</tr>
<tr>
<td><code>cli/commands/slice.zig</code></td>
<td><code>SliceCommand</code>, <code>execute()</code></td>
<td>Handles <code>context-slice slice</code> (re-compress existing IR)</td>
</tr>
<tr>
<td><code>cli/commands/prompt.zig</code></td>
<td><code>PromptCommand</code>, <code>execute()</code></td>
<td>Handles <code>context-slice prompt &quot;&lt;task&gt;&quot;</code></td>
</tr>
<tr>
<td><code>cli/commands/diff.zig</code></td>
<td><code>DiffCommand</code>, <code>execute()</code></td>
<td>Post-MVP: <code>context-slice diff &lt;s1&gt; &lt;s2&gt;</code></td>
</tr>
</tbody>
</table>
<p><strong>Boundary out:</strong> Each command handler receives a fully parsed <code>Args</code> struct and delegates immediately to the Orchestrator or AI Integration layer. The CLI layer never reads IR or constructs graphs.</p>
<hr>
<h3 id="32-orchestrator-layer">3.2 Orchestrator Layer</h3>
<p><strong>Location:</strong> <code>context-slicer/src/orchestrator/</code>
<strong>Role:</strong> Detect repo type, set up the working directory, write <code>manifest.json</code>, spawn and supervise the adapter subprocess, validate adapter exit.</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Struct / Function</th>
<th>Responsibility</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>orchestrator/orchestrator.zig</code></td>
<td><code>Orchestrator</code>, <code>run()</code></td>
<td>Top-level coordination: detect → manifest → spawn → wait</td>
</tr>
<tr>
<td><code>orchestrator/detector.zig</code></td>
<td><code>RepoDetector</code>, <code>detect()</code></td>
<td>Scans for <code>pom.xml</code>, <code>build.gradle</code>, <code>mvnw</code>, <code>go.mod</code>, etc.; returns <code>Language</code> enum</td>
</tr>
<tr>
<td><code>orchestrator/manifest.zig</code></td>
<td><code>Manifest</code>, <code>write()</code></td>
<td>Constructs and serializes <code>manifest.json</code> to <code>.context-slice/</code></td>
</tr>
<tr>
<td><code>orchestrator/subprocess.zig</code></td>
<td><code>Subprocess</code>, <code>spawn()</code>, <code>wait()</code></td>
<td>Cross-platform subprocess launch, stdout/stderr capture, exit code handling</td>
</tr>
</tbody>
</table>
<p><strong>Key types:</strong></p>
<pre class="hljs"><code><div>// orchestrator/detector.zig
pub const Language = enum { java, go, python, cpp, unknown };

// orchestrator/manifest.zig
pub const Manifest = struct {
    scenario_name: []const u8,
    entry_points: []const []const u8,
    run_args: []const []const u8,
    config_files: []const []const u8,
    output_dir: []const u8,
};
</div></code></pre>
<p><strong>Boundary in:</strong> <code>RecordCommand.execute()</code> provides scenario name and CLI flags.
<strong>Boundary out:</strong> Adapter subprocess is launched; Orchestrator blocks until it exits with code 0. On success, hands control to the IR Loader. On failure, emits an error and exits.</p>
<hr>
<h3 id="33-ir-layer">3.3 IR Layer</h3>
<p><strong>Location:</strong> <code>context-slicer/src/ir/</code>
<strong>Role:</strong> Parse, validate, and merge the two JSON files emitted by the adapter. This layer is the correctness gate — malformed or incompatible IR never reaches the graph layer.</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Struct / Function</th>
<th>Responsibility</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ir/types.zig</code></td>
<td><code>IrFile</code>, <code>Symbol</code>, <code>CallEdge</code>, <code>ConfigRead</code>, <code>RuntimeEntry</code>, <code>IrRoot</code></td>
<td>Canonical in-memory IR types used by all downstream layers</td>
</tr>
<tr>
<td><code>ir/loader.zig</code></td>
<td><code>IrLoader</code>, <code>loadStatic()</code>, <code>loadRuntime()</code></td>
<td>Reads and JSON-parses <code>static_ir.json</code> and <code>runtime_trace.json</code></td>
</tr>
<tr>
<td><code>ir/validator.zig</code></td>
<td><code>IrValidator</code>, <code>validate()</code></td>
<td>Checks <code>ir_version</code> compatibility; rejects symbols with missing IDs or null file refs; logs warnings for quarantined symbols</td>
</tr>
<tr>
<td><code>ir/merger.zig</code></td>
<td><code>IrMerger</code>, <code>merge()</code></td>
<td>Joins static symbols with runtime observation data; annotates <code>CallEdge.runtime_observed</code> and <code>call_count</code>; deduplicates symbols</td>
</tr>
</tbody>
</table>
<p><strong>Key types:</strong></p>
<pre class="hljs"><code><div>// ir/types.zig
pub const Symbol = struct {
    id: []const u8,
    kind: SymbolKind,          // .class, .method, .constructor, .interface
    name: []const u8,
    language: []const u8,
    file_id: []const u8,
    line_start: u32,
    line_end: u32,
    visibility: []const u8,
    container: ?[]const u8,
    annotations: []const []const u8,
    is_entry_point: bool,
    is_framework: bool,
    is_generated: bool,
};

pub const CallEdge = struct {
    caller: []const u8,        // Symbol ID
    callee: []const u8,        // Symbol ID
    static: bool,
    runtime_observed: bool,
    call_count: u64,
};

pub const ConfigRead = struct {
    symbol_id: []const u8,
    config_key: []const u8,
    resolved_value: []const u8,
    source_file: []const u8,
};
</div></code></pre>
<p><strong>Boundary in:</strong> <code>.context-slice/static_ir.json</code>, <code>.context-slice/runtime_trace.json</code>
<strong>Boundary out:</strong> A merged <code>IrRoot</code> struct containing deduplicated symbols, annotated call edges, and config reads. This is handed to the Graph Builder.</p>
<hr>
<h3 id="34-graph-layer">3.4 Graph Layer</h3>
<p><strong>Location:</strong> <code>context-slicer/src/graph/</code>
<strong>Role:</strong> Construct an in-memory weighted directed graph from the merged IR. Build and expose the hot path. Run neighborhood expansion.</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Struct / Function</th>
<th>Responsibility</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>graph/graph.zig</code></td>
<td><code>Graph</code>, <code>addNode()</code>, <code>addEdge()</code>, <code>getNeighbors()</code></td>
<td>Core directed graph: nodes are symbol IDs (string keys), edges carry weight and metadata</td>
</tr>
<tr>
<td><code>graph/builder.zig</code></td>
<td><code>GraphBuilder</code>, <code>build()</code></td>
<td>Iterates merged IR; inserts symbol nodes, call edges (weighted by <code>call_count</code>), config dependency edges, file ownership entries</td>
</tr>
<tr>
<td><code>graph/traversal.zig</code></td>
<td><code>Traversal</code>, <code>hotPath()</code>, <code>bfs()</code>, <code>dfs()</code></td>
<td>BFS/DFS traversal; extracts hot path (symbols with <code>call_count &gt; 0</code>) sorted by call frequency</td>
</tr>
<tr>
<td><code>graph/expansion.zig</code></td>
<td><code>NeighborhoodExpander</code>, <code>expand()</code></td>
<td>Radius-1 expansion from hot path; interface resolution; config file inclusion</td>
</tr>
</tbody>
</table>
<p><strong>Key types:</strong></p>
<pre class="hljs"><code><div>// graph/graph.zig
pub const EdgeMeta = struct {
    call_count: u64,
    runtime_observed: bool,
    static: bool,
};

pub const Graph = struct {
    nodes: std.StringHashMap(Symbol),
    edges: std.ArrayList(Edge),
    file_map: std.StringHashMap([]const u8),  // symbol_id -&gt; file_path
    // ...
};
</div></code></pre>
<p><strong>Boundary in:</strong> Merged <code>IrRoot</code> from the IR Layer.
<strong>Boundary out:</strong> A <code>Graph</code> struct and an ordered <code>hot_path: []const []const u8</code> (symbol ID slice). These are consumed by the Compression Layer.</p>
<hr>
<h3 id="35-compression-layer">3.5 Compression Layer</h3>
<p><strong>Location:</strong> <code>context-slicer/src/compression/</code>
<strong>Role:</strong> Reduce the expanded graph to a minimal, high-signal slice. Remove noise. Produce the final set of symbols and files to include in AI context.</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Struct / Function</th>
<th>Responsibility</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>compression/filter.zig</code></td>
<td><code>FrameworkFilter</code>, <code>apply()</code></td>
<td>Removes nodes where <code>is_framework=true</code> unless explicitly included by expansion; drops edges below configurable <code>call_count</code> threshold</td>
</tr>
<tr>
<td><code>compression/dedup.zig</code></td>
<td><code>StackDeduplicator</code>, <code>deduplicate()</code></td>
<td>Collapses recursive call patterns; removes duplicate edges between the same caller/callee pair</td>
</tr>
<tr>
<td><code>compression/compressor.zig</code></td>
<td><code>Compressor</code>, <code>compress()</code></td>
<td>Orchestrates filter → dedup → ordering; produces a <code>Slice</code> struct: ordered symbol list, file list, config influence summary</td>
</tr>
</tbody>
</table>
<p><strong>Key types:</strong></p>
<pre class="hljs"><code><div>// compression/compressor.zig
pub const Slice = struct {
    ordered_symbols: []const Symbol,    // entry point to leaves, post-compression
    relevant_file_paths: []const []const u8,
    config_influences: []const ConfigInfluence,
    call_graph_edges: []const CallEdge,
};

pub const ConfigInfluence = struct {
    config_key: []const u8,
    resolved_value: []const u8,
    source_file: []const u8,
    influenced_symbols: []const []const u8,
};
</div></code></pre>
<p><strong>Boundary in:</strong> <code>Graph</code> + hot path from the Graph Layer.
<strong>Boundary out:</strong> A <code>Slice</code> struct. This is the final compressed representation passed to the Packager.</p>
<hr>
<h3 id="36-packager-layer">3.6 Packager Layer</h3>
<p><strong>Location:</strong> <code>context-slicer/src/packager/</code>
<strong>Role:</strong> Write the <code>Slice</code> to human- and AI-readable files in <code>.context-slice/</code>. This is the final output of the <code>record</code> and <code>slice</code> commands.</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Struct / Function</th>
<th>Responsibility</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>packager/architecture_writer.zig</code></td>
<td><code>ArchitectureWriter</code>, <code>write()</code></td>
<td>Generates <code>architecture.md</code>: ordered call path narrative from entry point to leaf symbols</td>
</tr>
<tr>
<td><code>packager/config_writer.zig</code></td>
<td><code>ConfigWriter</code>, <code>write()</code></td>
<td>Generates <code>config_usage.md</code>: table of config keys, resolved values, and which code paths they influenced</td>
</tr>
<tr>
<td><code>packager/packager.zig</code></td>
<td><code>Packager</code>, <code>pack()</code></td>
<td>Orchestrates all writers; writes <code>relevant_files.txt</code>, <code>call_graph.json</code>, <code>metadata.json</code></td>
</tr>
</tbody>
</table>
<p><strong>Output files written:</strong></p>
<table>
<thead>
<tr>
<th>File</th>
<th>Format</th>
<th>Consumer</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>architecture.md</code></td>
<td>Markdown</td>
<td>AI context preamble</td>
</tr>
<tr>
<td><code>relevant_files.txt</code></td>
<td>Newline-delimited paths</td>
<td>AI Integration Layer</td>
</tr>
<tr>
<td><code>call_graph.json</code></td>
<td>JSON</td>
<td>AI context, debugging</td>
</tr>
<tr>
<td><code>config_usage.md</code></td>
<td>Markdown</td>
<td>AI context preamble</td>
</tr>
<tr>
<td><code>metadata.json</code></td>
<td>JSON</td>
<td>Freshness checks, versioning</td>
</tr>
</tbody>
</table>
<p><strong>Boundary in:</strong> <code>Slice</code> from Compression Layer.
<strong>Boundary out:</strong> Files written to <code>.context-slice/</code>. Control returns to the CLI.</p>
<hr>
<h3 id="37-ai-integration-layer">3.7 AI Integration Layer</h3>
<p><strong>Location:</strong> <code>context-slicer/src/ai/</code>
<strong>Role:</strong> Read the packaged slice, assemble a Claude prompt, call the API, and stream the response to the terminal. Activated by the <code>prompt</code> subcommand.</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Struct / Function</th>
<th>Responsibility</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ai/prompt_builder.zig</code></td>
<td><code>PromptBuilder</code>, <code>build()</code></td>
<td>Reads <code>relevant_files.txt</code>, loads file contents, prepends <code>architecture.md</code> + <code>config_usage.md</code>, appends user task</td>
</tr>
<tr>
<td><code>ai/claude.zig</code></td>
<td><code>ClaudeClient</code>, <code>complete()</code></td>
<td>HTTP POST to Anthropic Messages API; streams response chunks to stdout</td>
</tr>
</tbody>
</table>
<p><strong>Boundary in:</strong> <code>.context-slice/</code> directory (reads packaged output) + user task string from CLI.
<strong>Boundary out:</strong> Streamed Claude response to terminal.</p>
<hr>
<h3 id="38-utility-layer">3.8 Utility Layer</h3>
<p><strong>Location:</strong> <code>context-slicer/src/util/</code>
<strong>Role:</strong> Shared helpers. No business logic.</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>util/json.zig</code></td>
<td>Thin helpers over <code>std.json</code> for common parse/serialize patterns</td>
</tr>
<tr>
<td><code>util/fs.zig</code></td>
<td>Directory creation, path joining, recursive file reads</td>
</tr>
<tr>
<td><code>util/hash.zig</code></td>
<td>SHA-256 file hashing for <code>metadata.json</code> build ID fields</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="4-subsystem-java-adapter">4. Subsystem: Java Adapter</h2>
<p><strong>Location:</strong> <code>context-adapter-java/src/main/java/com/contextslice/adapter/</code>
<strong>Build artifact:</strong> <code>context-adapter-java.jar</code> (fat JAR via Maven Assembly or Shade plugin)
<strong>Role:</strong> All Java-specific extraction. Runs as a subprocess. Never linked into the Zig core.</p>
<h3 id="41-entry-point--manifest">4.1 Entry Point &amp; Manifest</h3>
<table>
<thead>
<tr>
<th>Class</th>
<th>Responsibility</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AdapterMain</code></td>
<td><code>public static void main(String[] args)</code>: parses <code>--manifest</code> and <code>--output</code> flags; orchestrates static analysis → build → runtime → IR emission phases sequentially</td>
</tr>
<tr>
<td><code>manifest.ManifestReader</code></td>
<td>Reads and deserializes <code>manifest.json</code> into a <code>ManifestConfig</code> POJO</td>
</tr>
<tr>
<td><code>manifest.ManifestConfig</code></td>
<td>POJO: <code>scenarioName</code>, <code>entryPoints</code>, <code>runArgs</code>, <code>configFiles</code>, <code>outputDir</code></td>
</tr>
</tbody>
</table>
<hr>
<h3 id="42-static-analysis-module">4.2 Static Analysis Module</h3>
<p><strong>Package:</strong> <code>com.contextslice.adapter.static_analysis</code></p>
<table>
<thead>
<tr>
<th>Class</th>
<th>Responsibility</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>StaticAnalyzer</code></td>
<td>Orchestrates the full static analysis pass; returns <code>StaticIr</code> aggregate</td>
</tr>
<tr>
<td><code>SourceRootResolver</code></td>
<td>Parses <code>pom.xml</code> (via Maven Model) or <code>build.gradle</code> (text heuristic) to find <code>src/main/java</code> roots and classpath jars</td>
</tr>
<tr>
<td><code>JdtAstParser</code></td>
<td>Initializes Eclipse JDT <code>ASTParser</code>; sets <code>setResolveBindings(true)</code>, <code>setEnvironment()</code> with classpath; triggers multi-file parse across all source roots</td>
</tr>
<tr>
<td><code>SymbolExtractor</code></td>
<td><code>ASTVisitor</code> subclass: visits <code>TypeDeclaration</code>, <code>MethodDeclaration</code>, <code>FieldDeclaration</code>; builds <code>List&lt;IrSymbol&gt;</code></td>
</tr>
<tr>
<td><code>CallEdgeExtractor</code></td>
<td><code>ASTVisitor</code> subclass: visits <code>MethodInvocation</code>, <code>ClassInstanceCreation</code>; resolves bindings to fully-qualified names; builds <code>List&lt;IrCallEdge&gt;</code></td>
</tr>
<tr>
<td><code>AnnotationProcessor</code></td>
<td>Inspects annotation lists on symbols; sets <code>isFramework=true</code> for Spring stereotypes (<code>@Component</code>, <code>@Service</code>, <code>@Repository</code>, <code>@Controller</code>, <code>@Bean</code>); records annotation strings</td>
</tr>
</tbody>
</table>
<p><strong>Key Spring annotations flagged as <code>isFramework=true</code>:</strong>
<code>@Component</code>, <code>@Service</code>, <code>@Repository</code>, <code>@Controller</code>, <code>@RestController</code>, <code>@Configuration</code>, <code>@Bean</code>, <code>@Autowired</code>, <code>@Transactional</code>, <code>@Scheduled</code>, <code>@EventListener</code></p>
<hr>
<h3 id="43-build-module">4.3 Build Module</h3>
<p><strong>Package:</strong> <code>com.contextslice.adapter.build</code></p>
<table>
<thead>
<tr>
<th>Class</th>
<th>Responsibility</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>BuildRunner</code></td>
<td>Invokes <code>mvn package -DskipTests</code> or <code>gradle assemble</code> via <code>ProcessBuilder</code>; returns path to produced JAR; throws on non-zero exit</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="44-runtime-instrumentation-module">4.4 Runtime Instrumentation Module</h3>
<p><strong>Package:</strong> <code>com.contextslice.adapter.runtime</code></p>
<table>
<thead>
<tr>
<th>Class</th>
<th>Responsibility</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AgentLauncher</code></td>
<td>Constructs the <code>java -javaagent:context-agent.jar -jar &lt;app.jar&gt; &lt;run_args&gt;</code> command; launches it via <code>ProcessBuilder</code>; streams stdout/stderr; waits for process exit; returns path to <code>runtime_trace.json</code> written by the agent's shutdown hook</td>
</tr>
</tbody>
</table>
<p>Note: <code>AgentLauncher</code> does <strong>not</strong> contain the agent logic — it only launches the target JVM. The agent logic lives in the separate <code>context-agent-java</code> module (Section 5).</p>
<hr>
<h3 id="45-ir-emitter">4.5 IR Emitter</h3>
<p><strong>Package:</strong> <code>com.contextslice.adapter.ir</code></p>
<table>
<thead>
<tr>
<th>Class</th>
<th>Responsibility</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>IrModel</code></td>
<td>POJOs matching the IR schema: <code>IrRoot</code>, <code>IrFile</code>, <code>IrSymbol</code>, <code>IrCallEdge</code>, <code>IrConfigRead</code>, <code>IrRuntime</code>, <code>IrObservedSymbol</code></td>
</tr>
<tr>
<td><code>SymbolIdGenerator</code></td>
<td>Produces deterministic IDs: <code>java::&lt;fully-qualified-class&gt;::&lt;method&gt;(&lt;param-types&gt;)</code></td>
</tr>
<tr>
<td><code>IrMerger</code></td>
<td>Joins <code>StaticIr</code> (from static analysis) with <code>RuntimeTrace</code> (from agent output file); annotates each <code>IrCallEdge</code> with <code>runtimeObserved</code> and <code>callCount</code> from the runtime data; deduplicates symbols</td>
</tr>
<tr>
<td><code>IrSerializer</code></td>
<td>Serializes merged <code>IrRoot</code> to <code>static_ir.json</code> (static phase) and forwards <code>runtime_trace.json</code> (already written by agent); also writes <code>metadata.json</code></td>
</tr>
</tbody>
</table>
<p><strong>Serialization contract:</strong> All arrays are sorted by <code>id</code> before serialization for deterministic output. Uses Gson with <code>GsonBuilder().setPrettyPrinting()</code>.</p>
<hr>
<h2 id="5-subsystem-bytebuddy-agent">5. Subsystem: ByteBuddy Agent</h2>
<p><strong>Location:</strong> <code>context-agent-java/src/main/java/com/contextslice/agent/</code>
<strong>Build artifact:</strong> <code>context-agent.jar</code> — must declare <code>Premain-Class</code> in <code>MANIFEST.MF</code>
<strong>Role:</strong> Attached via <code>-javaagent:</code> to the <em>target application's</em> JVM. Instruments app methods at class-load time. Aggregates call data in memory. Writes <code>runtime_trace.json</code> on JVM shutdown.</p>
<table>
<thead>
<tr>
<th>Class</th>
<th>Responsibility</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AgentBootstrap</code></td>
<td><code>premain(String args, Instrumentation inst)</code>: configures <code>AgentBuilder.Default()</code> with type matchers excluding CGLIB/JDK proxies; installs method advice and config advice; registers shutdown hook</td>
</tr>
<tr>
<td><code>MethodAdvice</code></td>
<td><code>@Advice.OnMethodEnter</code>: peeks current caller from thread-local stack; records call edge; pushes self. <code>@Advice.OnMethodExit</code>: pops self from stack</td>
</tr>
<tr>
<td><code>ConfigAdvice</code></td>
<td><code>@Advice.OnMethodExit</code> on <code>AbstractEnvironment.getProperty(String)</code>: records <code>(currentMethod, key, returnValue)</code> to <code>RuntimeTracer.configReads</code></td>
</tr>
<tr>
<td><code>RuntimeTracer</code></td>
<td>Static class: <code>ThreadLocal&lt;Deque&lt;String&gt;&gt; stack</code>; <code>ConcurrentHashMap&lt;String, LongAdder&gt; methodCounts</code>; <code>ConcurrentHashMap&lt;String, LongAdder&gt; edgeCounts</code>; <code>ConcurrentHashMap&lt;String, String&gt; configReads</code>; static <code>push/pop/peek/recordEdge/recordConfig</code> methods</td>
</tr>
<tr>
<td><code>ShutdownHook</code></td>
<td><code>Runnable</code> registered with <code>Runtime.getRuntime().addShutdownHook()</code>: builds <code>RuntimeTrace</code> POJO from <code>RuntimeTracer</code> maps; serializes to <code>runtime_trace.json</code> via Gson</td>
</tr>
<tr>
<td><code>RuntimeTrace</code></td>
<td>POJO: <code>List&lt;ObservedSymbol&gt;</code>, <code>List&lt;ObservedEdge&gt;</code>, <code>List&lt;ConfigRead&gt;</code> — matches the <code>runtime</code> block of the IR schema</td>
</tr>
</tbody>
</table>
<p><strong>Type matcher configuration in <code>AgentBootstrap</code>:</strong></p>
<pre class="hljs"><code><div>include: nameStartsWith(&quot;com.company&quot;)          // restrict to app namespace
exclude: nameContains(&quot;$$EnhancerBySpring&quot;)     // CGLIB proxies
exclude: nameContains(&quot;$Proxy&quot;)                 // JDK dynamic proxies
exclude: nameContains(&quot;CGLIB&quot;)                  // other CGLIB artifacts
</div></code></pre>
<hr>
<h2 id="6-shared-artifact-space--context-slice">6. Shared Artifact Space — <code>.context-slice/</code></h2>
<p>This directory is the <strong>sole communication channel</strong> between the Zig core and the Java adapter. It is created by the Zig Orchestrator before the adapter is spawned and is read back by the Zig IR Loader after the adapter exits.</p>
<pre class="hljs"><code><div>.context-slice/
  manifest.json          # Written by Zig Orchestrator → read by Java Adapter
  static_ir.json         # Written by Java Adapter (static phase) → read by Zig IR Loader
  runtime_trace.json     # Written by ByteBuddy Agent (via ShutdownHook) → read by Zig IR Loader
  metadata.json          # Written by Java Adapter (IR Emitter) → read by Zig Packager
  architecture.md        # Written by Zig Packager → read by AI Integration Layer
  relevant_files.txt     # Written by Zig Packager → read by AI Integration Layer
  call_graph.json        # Written by Zig Packager → optional debugging
  config_usage.md        # Written by Zig Packager → read by AI Integration Layer
</div></code></pre>
<p><strong>Schema versioning:</strong> <code>static_ir.json</code> and <code>runtime_trace.json</code> carry <code>ir_version</code> fields. The Zig IR Validator checks these against the compiled-in <code>SUPPORTED_IR_VERSION</code> constant. A mismatch causes an early, clear error.</p>
<hr>
<h2 id="7-subsystem-boundaries">7. Subsystem Boundaries</h2>
<h3 id="boundary-1-cli-layer-%E2%86%92-orchestrator--ai-layer">Boundary 1: CLI Layer → Orchestrator / AI Layer</h3>
<p><strong>Direction:</strong> One-way call
<strong>Contract:</strong> <code>RecordCommand.execute()</code> and <code>SliceCommand.execute()</code> pass a typed <code>RecordArgs</code> / <code>SliceArgs</code> struct to <code>Orchestrator.run()</code>. <code>PromptCommand.execute()</code> passes a <code>PromptArgs</code> struct to <code>PromptBuilder</code>. The CLI layer holds no state after dispatch.</p>
<hr>
<h3 id="boundary-2-zig-orchestrator-%E2%86%94-java-adapter-subprocess">Boundary 2: Zig Orchestrator ↔ Java Adapter (subprocess)</h3>
<p><strong>Direction:</strong> File-based IPC
<strong>Write side (Zig):</strong> Orchestrator writes <code>manifest.json</code> then calls <code>Subprocess.spawn()</code>.
<strong>Read side (Java):</strong> <code>AdapterMain</code> reads <code>manifest.json</code> via <code>ManifestReader</code>.
<strong>Return path (Java → Zig):</strong> Adapter writes <code>static_ir.json</code>, <code>runtime_trace.json</code>, <code>metadata.json</code> to <code>.context-slice/</code> then exits 0.
<strong>Contract enforcement:</strong> Zig waits on the subprocess exit code. Non-zero exit aborts with an error. Zig IR Validator enforces schema version on the produced files.
<strong>No shared memory, no sockets, no RPC.</strong> This boundary is intentionally coarse.</p>
<hr>
<h3 id="boundary-3-java-adapter-%E2%86%94-bytebuddy-agent-separate-jvm">Boundary 3: Java Adapter ↔ ByteBuddy Agent (separate JVM)</h3>
<p><strong>Direction:</strong> File-based IPC (one-way: agent writes)
<strong>Write side (Agent):</strong> <code>ShutdownHook</code> writes <code>runtime_trace.json</code> to the output path passed via agent args.
<strong>Read side (Adapter):</strong> <code>AgentLauncher</code> waits for the target JVM to exit, then passes the <code>runtime_trace.json</code> path to <code>IrMerger</code>.
<strong>Contract:</strong> The agent JAR is a separate build artifact. The adapter only cares about the file it produces — not how it was produced.</p>
<hr>
<h3 id="boundary-4-ir-layer-%E2%86%92-graph-layer">Boundary 4: IR Layer → Graph Layer</h3>
<p><strong>Direction:</strong> In-process struct handoff
<strong>Contract:</strong> <code>IrMerger.merge()</code> returns an <code>IrRoot</code> struct. <code>GraphBuilder.build()</code> accepts <code>IrRoot</code> and produces <code>Graph</code>. No JSON serialization crosses this boundary. The IR Layer is responsible for correctness; the Graph Layer assumes a valid, deduplicated <code>IrRoot</code>.</p>
<hr>
<h3 id="boundary-5-graph-layer-%E2%86%92-compression-layer">Boundary 5: Graph Layer → Compression Layer</h3>
<p><strong>Direction:</strong> In-process struct handoff
<strong>Contract:</strong> <code>GraphBuilder.build()</code> returns a <code>Graph</code>. <code>NeighborhoodExpander.expand()</code> returns an expanded <code>Graph</code> + <code>hot_path</code>. <code>Compressor.compress()</code> accepts both and returns a <code>Slice</code>. The Graph Layer does not make decisions about what to include or exclude — that is the Compression Layer's responsibility.</p>
<hr>
<h3 id="boundary-6-compression-layer-%E2%86%92-packager-layer">Boundary 6: Compression Layer → Packager Layer</h3>
<p><strong>Direction:</strong> In-process struct handoff
<strong>Contract:</strong> <code>Compressor.compress()</code> returns a <code>Slice</code> struct. <code>Packager.pack()</code> accepts <code>Slice</code> and writes files. The Packager does not filter or score — it faithfully serializes what the Compression Layer produced.</p>
<hr>
<h3 id="boundary-7-packager-layer-%E2%86%92-ai-integration-layer">Boundary 7: Packager Layer → AI Integration Layer</h3>
<p><strong>Direction:</strong> File system
<strong>Contract:</strong> The AI Integration Layer reads <code>.context-slice/</code> — specifically <code>relevant_files.txt</code>, <code>architecture.md</code>, and <code>config_usage.md</code>. It also reads the source files listed in <code>relevant_files.txt</code> directly from the repo. This boundary is intentionally file-based so the packaged slice can be inspected, version-controlled, or reused by multiple <code>prompt</code> invocations without re-running the full pipeline.</p>
<hr>
<h2 id="8-data-flow-summary">8. Data Flow Summary</h2>
<pre class="hljs"><code><div>User
  │
  │  context-slice record submit-order --config app-prod.yml
  ▼
CLI Layer (cli.zig, commands/record.zig)
  │  RecordArgs
  ▼
Orchestrator (orchestrator.zig, detector.zig, manifest.zig, subprocess.zig)
  │  writes manifest.json → spawns java -jar context-adapter-java.jar
  ▼
Java Adapter (AdapterMain)
  ├── StaticAnalyzer → JDT AST walk → List&lt;IrSymbol&gt;, List&lt;IrCallEdge&gt;
  ├── BuildRunner → mvn package → app.jar
  ├── AgentLauncher → launches app with context-agent.jar
  │     └── ByteBuddy Agent (in target JVM)
  │           RuntimeTracer accumulates call data during scenario
  │           ShutdownHook → runtime_trace.json
  └── IrMerger + IrSerializer → static_ir.json, metadata.json
  │  exits 0
  ▼
IR Layer (loader.zig, validator.zig, merger.zig)
  │  IrRoot (merged, validated, deduplicated)
  ▼
Graph Layer (builder.zig, graph.zig, traversal.zig, expansion.zig)
  │  Graph + hot_path
  ▼
Compression Layer (filter.zig, dedup.zig, compressor.zig)
  │  Slice
  ▼
Packager Layer (packager.zig, architecture_writer.zig, config_writer.zig)
  │  writes .context-slice/{architecture.md, relevant_files.txt, ...}
  ▼
  [record command completes]

User
  │
  │  context-slice prompt &quot;Add idempotency to order submission&quot;
  ▼
CLI Layer (commands/prompt.zig)
  │  PromptArgs
  ▼
AI Integration Layer (prompt_builder.zig, claude.zig)
  │  reads .context-slice/ + source files
  │  POST /v1/messages to Anthropic API
  ▼
Claude response streamed to terminal
</div></code></pre>
<hr>
<p><em>Context Slice — Technical Implementation Document v0.1 — MVP</em></p>

</body>
</html>
